//----------------------------------
// CVE : CVE-2024-21338
// Name : Windows Kernel Elevation of Privilege Vulnerability
// Dev  : 0xdy
//----------------------------------

#include <windows.h>
#include <stdio.h>
#include "../../color/colorPrint.h"

#pragma comment(lib, "Version.lib")

// -------------------------------------------------------
// Helper â€“ Get file version of a system driver
// -------------------------------------------------------
BOOL GetFileVersion(const wchar_t* filePath, DWORD* major, DWORD* minor, DWORD* build, DWORD* revision) {
    DWORD handle = 0;
    DWORD size = GetFileVersionInfoSizeW(filePath, &handle);
    if (!size) return FALSE;

    BYTE* buffer = (BYTE*)malloc(size);
    if (!GetFileVersionInfoW(filePath, handle, size, buffer)) {
        free(buffer);
        return FALSE;
    }

    VS_FIXEDFILEINFO* fileInfo = NULL;
    UINT len = 0;
    if (!VerQueryValueW(buffer, L"\\", (LPVOID*)&fileInfo, &len)) {
        free(buffer);
        return FALSE;
    }

    if (fileInfo) {
        *major    = HIWORD(fileInfo->dwFileVersionMS);
        *minor    = LOWORD(fileInfo->dwFileVersionMS);
        *build    = HIWORD(fileInfo->dwFileVersionLS);
        *revision = LOWORD(fileInfo->dwFileVersionLS);
        free(buffer);
        return TRUE;
    }

    free(buffer);
    return FALSE;
}

// -------------------------------------------------------
// Vulnerability Detection Logic (No exploitation)
// -------------------------------------------------------
BOOL IsVulnerable_CVE_2024_21338() {
    DWORD major, minor, build, revision;

    // Win32k.sys path
    const wchar_t* driverPath = L"C:\\Windows\\System32\\win32k.sys";

    if (!GetFileVersion(driverPath, &major, &minor, &build, &revision)) {
        printError(L"[ERROR] Cannot read version of win32k.sy\n");
        return FALSE;
    }

    wchar_t versionInfo[100];
    swprintf(versionInfo, 100, L"win32k.sys version: %lu.%lu.%lu.%lu", major, minor, build, revision);
    printInfo(versionInfo);

    if (major == 10 && minor == 0) {
        // Windows 10 vulnerable builds (example baseline)
        if (build >= 19041 && build <= 19045) {
            return TRUE;
        }

        // Windows 11 pre-patch builds
        if (build >= 22000 && build < 22621) {
            return TRUE;
        }
    }

    return FALSE;
}

// -------------------------------------------------------
// Main Scanner
// -------------------------------------------------------
void CVE_2024_21338() {
    enableANSI();
    
    if (IsVulnerable_CVE_2024_21338()) {
        printSuccess(L"[VULNERABLE] System is affected by CVE-2024-21338\n");
        printInfo(L"Exploit : https://www.exploit-db.com/exploits/52275\n");
    } else {
        printError(L"[NOT VULNERABLE] System is not affected by CVE-2024-21338\n");
    }
}
