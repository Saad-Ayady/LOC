//----------------------------------
// CVE : CVE-2021-36934
// Name : Windows SeriousSAM Local Privilege Escalation
// Dev  : 0xdy
//----------------------------------

#include <windows.h>
#include <stdio.h>
#include <aclapi.h>
#include <sddl.h>
#include "../../color/colorPrint.h"
#pragma comment(lib, "Advapi32.lib")

// -------------------------------------------------------
// Helper – Check Volume Shadow Copy Service
// -------------------------------------------------------
BOOL IsVSSEnabled() {
    SC_HANDLE scManager = OpenSCManager(NULL, NULL, SC_MANAGER_CONNECT);
    if (!scManager) {
        printError(L"[ERROR] Cannot open Service Manager");
        return FALSE;
    }

    SC_HANDLE vssService = OpenServiceW(scManager, L"VSS", SERVICE_QUERY_STATUS);
    if (!vssService) {
        CloseServiceHandle(scManager);
        return FALSE;
    }

    SERVICE_STATUS_PROCESS status;
    DWORD bytesNeeded;
    if (!QueryServiceStatusEx(vssService, SC_STATUS_PROCESS_INFO, 
                             (LPBYTE)&status, sizeof(status), &bytesNeeded)) {
        CloseServiceHandle(vssService);
        CloseServiceHandle(scManager);
        return FALSE;
    }

    CloseHandle(vssService);
    CloseHandle(scManager);

    return (status.dwCurrentState == SERVICE_RUNNING);
}

// -------------------------------------------------------
// Helper – Check SAM file permissions
// -------------------------------------------------------
BOOL CheckSAMPermissions() {
    const wchar_t* samPaths[] = {
        L"C:\\Windows\\System32\\config\\SAM",
        L"C:\\Windows\\System32\\config\\SYSTEM",
        L"C:\\Windows\\System32\\config\\SECURITY"
    };

    BOOL isVulnerable = FALSE;
    wchar_t message[512];

    for (int i = 0; i < 3; i++) {
        DWORD dwRes;
        PSECURITY_DESCRIPTOR pSD = NULL;
        
        dwRes = GetNamedSecurityInfoW(
            samPaths[i],
            SE_FILE_OBJECT,
            OWNER_SECURITY_INFORMATION | DACL_SECURITY_INFORMATION,
            NULL, NULL, NULL, NULL, &pSD
        );

        if (dwRes == ERROR_SUCCESS && pSD) {
            BOOL daclPresent, daclDefaulted;
            PACL pDacl;
            
            if (GetSecurityDescriptorDacl(pSD, &daclPresent, &pDacl, &daclDefaulted)) {
                if (!daclPresent || pDacl == NULL) {
                    swprintf(message, 512, L"[WARNING] %s has no DACL (full access)", samPaths[i]);
                    printYellow(message);
                    isVulnerable = TRUE;
                } else {
                    swprintf(message, 512, L"[INFO] %s has proper DACL", samPaths[i]);
                    printBlue(message);
                }
            }
            LocalFree(pSD);
        } else {
            swprintf(message, 512, L"[ERROR] Cannot get security info for %s (Error: %lu)", 
                   samPaths[i], GetLastError());
            printError(message);
        }
    }

    return isVulnerable;
}

// -------------------------------------------------------
// Helper – Check build version
// -------------------------------------------------------
BOOL CheckVulnerableBuild() {
    OSVERSIONINFOEXW osInfo = {0};
    osInfo.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEXW);
    
    if (!GetVersionExW((LPOSVERSIONINFOW)&osInfo)) {
        printError(L"[ERROR] Cannot get OS version");
        return FALSE;
    }

    wchar_t versionInfo[256];
    swprintf(versionInfo, 256, L"[INFO] Windows Version: %lu.%lu (Build %lu)", 
             osInfo.dwMajorVersion, osInfo.dwMinorVersion, osInfo.dwBuildNumber);
    printInfo(versionInfo);

    if (osInfo.dwMajorVersion == 10) {
        if (osInfo.dwBuildNumber >= 17763) {
            if (osInfo.dwBuildNumber < 19041) {
                printInfo(L"[INFO] Detected Windows 10 1809/1903/1909");
                return (osInfo.dwBuildNumber == 17763 && osInfo.dwMinorVersion < 2114);
            } else if (osInfo.dwBuildNumber >= 19041 && osInfo.dwBuildNumber < 19044) {
                printInfo(L"[INFO] Detected Windows 10 2004/20H2/21H1");
                return (osInfo.dwBuildNumber < 19041);
            } else if (osInfo.dwBuildNumber >= 22000) {
                printInfo(L"[INFO] Detected Windows 11");
                return (osInfo.dwBuildNumber < 22000);
            } else if (osInfo.dwBuildNumber >= 20348) {
                printInfo(L"[INFO] Detected Windows Server 2022");
                return (osInfo.dwBuildNumber < 20348);
            }
        }
    }
    
    printInfo(L"[INFO] Windows version not in vulnerable range");
    return FALSE;
}

// -------------------------------------------------------
// Check shadow copies existence
// -------------------------------------------------------
BOOL CheckShadowCopies() {
    wchar_t command[] = L"cmd.exe /c vssadmin list shadows 2>&1 | find \"No items\"";
    
    STARTUPINFOW si = {0};
    PROCESS_INFORMATION pi = {0};
    si.cb = sizeof(si);
    si.dwFlags = STARTF_USESHOWWINDOW;
    si.wShowWindow = SW_HIDE;
    
    if (CreateProcessW(NULL, command, NULL, NULL, FALSE, CREATE_NO_WINDOW, NULL, NULL, &si, &pi)) {
        WaitForSingleObject(pi.hProcess, 3000);
        
        DWORD exitCode;
        GetExitCodeProcess(pi.hProcess, &exitCode);
        
        CloseHandle(pi.hProcess);
        CloseHandle(pi.hThread);
        
        return (exitCode == 0);
    }
    
    return FALSE;
}

// -------------------------------------------------------
// Main Vulnerability Detection
// -------------------------------------------------------
BOOL IsVulnerable_CVE_2021_36934() {
    printInfo(L"Scanning for CVE-2021-36934 (SeriousSAM)");
    printInfo(L"=========================================");
    
    printYellow(L"[*] Checking Windows build version...");
    if (!CheckVulnerableBuild()) {
        return FALSE;
    }
    printYellow(L"[+] System build is potentially vulnerable");
    
    printYellow(L"\n[*] Checking Volume Shadow Copy Service...");
    if (!IsVSSEnabled()) {
        printSuccess(L"[+] VSS service is not running (mitigated)");
        return FALSE;
    }
    printYellow(L"[+] VSS service is running");
    
    printYellow(L"\n[*] Checking for existing shadow copies...");
    if (CheckShadowCopies()) {
        printYellow(L"[+] Shadow copies detected");
    } else {
        printSuccess(L"[+] No shadow copies found");
    }
    
    printYellow(L"\n[*] Checking SAM file access permissions...");
    if (!CheckSAMPermissions()) {
        printSuccess(L"[+] SAM files have proper permissions");
        return FALSE;
    }
    printError(L"[!] SAM files might have insecure permissions");
    
    return TRUE;
}

// -------------------------------------------------------
// Display mitigation steps
// -------------------------------------------------------
void ShowMitigationSteps() {
    printBold(L"\n=== MITIGATION STEPS ===");
    printInfo(L"1. Apply Windows updates from October 2021 or later");
    printInfo(L"2. Restrict access to C:\\Windows\\System32\\config directory");
    printInfo(L"3. Delete unnecessary shadow copies:");
    printInfo(L"   vssadmin delete shadows /all /quiet");
    printInfo(L"4. Set proper ACLs on SAM files:");
    printInfo(L"   icacls C:\\Windows\\System32\\config\\* /inheritance:r");
    printInfo(L"5. Monitor for suspicious access to shadow copies");
    printInfo(L"6. Consider disabling VSS if not needed");
}

// -------------------------------------------------------
// Main Scanner Function
// -------------------------------------------------------
void CVE_2021_36934() {
    enableANSI(); 
    printBold(L" CVE-2021-36934 - SeriousSAM Vulnerability Scanner");
    
    if (IsVulnerable_CVE_2021_36934()) {
        printSuccess(L"\n[VULNERABLE] System is affected by CVE-2021-36934");
        printBold(L"\n=== VULNERABILITY DETAILS ===");
        printInfo(L"Name: Windows SeriousSAM Local Privilege Escalation");
        printInfo(L"CVE ID: CVE-2021-36934");
        printInfo(L"CVSS Score: 7.8 (High)");
        printInfo(L"Type: Local Privilege Escalation");
        printInfo(L"Vector: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H");
        printInfo(L"Affected: Windows 10 1809+ & Windows Server 2019+");
        
        ShowMitigationSteps();
        
        printInfo(L"\nReferences:");
        printInfo(L" - https://www.exploit-db.com/docs/50245");
        printInfo(L" - https://nvd.nist.gov/vuln/detail/CVE-2021-36934");
        printInfo(L" - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934");
        printInfo(L" - https://github.com/cube0x0/CVE-2021-36934");
    } else {
        printRed(L"\n[SAFE] System is NOT vulnerable to CVE-2021-36934");
        printInfo(L"[INFO] Ensure Windows is up to date with latest security patches");
    }
}
